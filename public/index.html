<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>aurevo — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=19" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root{
      --bg:#00d2ff; --bg-2:#ff6a00;
      --panel:#111827; --surface:#0e1530;
      --text:#e8eefc; --muted:#a9b6d3;
      --accent:#f59e0b; --danger:#b91c1c; --border:#1e2a46;
      --shadow:0 10px 26px rgba(0,0,0,.45); --r:14px;
      --scrim: rgba(0,0,0,.45);
    }
    *,*:before,*:after{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg),var(--bg-2));
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Poppins',Arial,sans-serif;
    }
    a{color:inherit;text-decoration:none}
    .shell{display:grid;grid-template-columns:1fr;min-height:100vh}

    /* Sidebar */
    .sidenav{
      position:fixed;left:0;top:0;bottom:0;z-index:1000;
      width:260px;padding:20px 16px;
      background:rgba(16,24,40,.92);border-right:1px solid var(--border);
      backdrop-filter: blur(8px);
      transform:translateX(-100%);   /* hidden by default */
      transition:transform .3s ease-in-out; /* slide animation */
      display:flex;flex-direction:column;
    }
    body.nav-open .sidenav{transform:translateX(0)}
    .sidehead{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .sideclose{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--border);border-radius:10px;background:#0a0f20;color:var(--text);cursor:pointer}

    .brand{display:flex;align-items:center;gap:.5rem;font-weight:800;font-size:1.35rem}
    .brand i{color:var(--accent);font-size:1.5rem}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .nav a,.nav button{
      display:flex;align-items:center;gap:.8rem;padding:12px 12px;border-radius:12px;color:var(--text);
      background:transparent;border:0;cursor:pointer;font:inherit;text-align:left
    }
    .nav a:hover,.nav button:hover{background:#0f1a36}
    .nav a.active{background:var(--panel);box-shadow:var(--shadow)}
    .nav .section{margin:8px 0 2px;color:var(--muted);font-size:.85rem}
    .btn-accent{background:var(--accent);color:#111827;border-radius:10px;justify-content:center}
    .btn-danger{background:var(--danger);color:#fff;border-radius:10px;justify-content:center}

    /* Scrim overlay */
    .scrim{
      display:block;
      position:fixed;
      inset:0;
      background:var(--scrim);
      z-index:900;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
    }
    body.nav-open .scrim{opacity:1;pointer-events:auto;}

    /* Main + Topbar */
    .main{display:flex;flex-direction:column;margin-left:0;transition:margin-left .3s ease}
    .topbar{
      display:flex;align-items:center;justify-content:flex-end;
      padding:14px 18px;border-bottom:1px solid var(--border);
      background:transparent;position:relative;
    }
    #navToggle{
      display:inline-flex;
      position:absolute;left:14px;top:10px;
      background:transparent;border:0;
      color:var(--text);font-size:1.5rem;
      cursor:pointer;z-index:1101;
    }
    .rolebox{display:flex;align-items:center;gap:10px;background:var(--panel);padding:8px 10px;border-radius:999px;box-shadow:var(--shadow);font-weight:700}
    .rolebox .avatar{width:32px;height:32px;border-radius:50%;object-fit:cover}

    .container{max-width:1100px;margin:20px auto;padding:0 18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .player{width:100%;aspect-ratio:16/9;border-radius:12px}
    .footer{color:var(--muted);text-align:center;padding:24px 12px;border-top:1px solid var(--border);margin-top:26px}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1a36;color:var(--muted);font-size:.75rem;margin-right:6px}

    /* Desktop view: sidebar fixed open */
    @media (min-width:900px){
      .sidenav{transform:none !important;}
      .scrim{display:none !important;}
      #navToggle{display:none;}
      .main{margin-left:260px;}
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- Sidebar -->
    <aside id="sidenav" class="sidenav" aria-hidden="true" aria-label="Main">
      <div class="sidehead">
        <div class="brand"><span>aurevo</span> <i class="ri-play-fill"></i></div>
        <button id="sideClose" class="sideclose" type="button" aria-label="Close menu"><i class="ri-close-line"></i></button>
      </div>
      <nav class="nav" id="sideNavLinks">
        <a class="active" href="/"><i class="ri-home-4-line"></i> Home</a>
        <a href="/videos.html"><i class="ri-movie-2-line"></i> All Videos</a>
        <a id="uploadLink" href="/upload.html" style="display:none"><i class="ri-upload-2-line"></i> My Uploads</a>
        <div class="section">Creator</div>
        <a id="sideUpload" href="/upload.html" class="btn-accent" style="display:none"><i class="ri-upload-2-line"></i> Upload</a>
        <div class="section">Account</div>
        <a id="leftSignIn" href="#" style="display:none"><i class="ri-login-circle-line"></i> Sign in</a>
        <a id="leftSignOut" href="#" class="btn-danger" style="display:none"><i class="ri-logout-circle-r-line"></i> Sign out</a>
      </nav>
    </aside>

    <!-- Main -->
    <div class="main">
      <header class="topbar">
        <button id="navToggle" type="button" aria-controls="sidenav" aria-expanded="false" aria-label="Open menu"><i class="ri-menu-2-line"></i></button>
        <div class="rolebox">
          <span id="roleBadge">Guest</span>
          <button id="btnRole" type="button" style="display:none"><i class="ri-exchange-line"></i><span>Switch</span></button>
          <img class="avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar">
        </div>
      </header>

      <main class="container">
        <section class="card">
          <h2>Welcome to Aurevo</h2>
          <p class="muted">Explore the latest videos with Aurevo. Create with Aurevo!</p>
          <p id="authMsg" class="muted"></p>
        </section>

        <section class="card" style="margin-top:14px">
          <h2>Latest videos</h2>
          <div id="latest" class="grid-cards"></div>
          <p id="latestStatus" class="muted"></p>
        </section>
      </main>

      <footer class="footer">© aurevo</footer>
    </div>
  </div>
  <div id="scrim" class="scrim" aria-hidden="true"></div>

  <!-- NO static MSAL script here. We'll load it dynamically only if the server says auth is enabled. -->

  <script>
    // Global state
    let HAS_AUTH = false;
    let ID_TOKEN = null;
    let ME = null;

    // --- UI helpers ---
    function renderAuthUI(){
      const role = ME?.role || (HAS_AUTH ? "Consumer" : "Guest");
      document.getElementById("roleBadge").textContent = role;

      // Upload links visible only for Creator when auth ON
      const canUpload = HAS_AUTH && role === "Creator";
      document.getElementById("uploadLink").style.display = canUpload ? "inline-flex" : "none";
      document.getElementById("sideUpload").style.display  = canUpload ? "inline-flex" : "none";

      // Sign in/out buttons only when auth ON
      document.getElementById("leftSignIn").style.display = HAS_AUTH && !ID_TOKEN ? "inline-flex" : "none";
      document.getElementById("leftSignOut").style.display = HAS_AUTH && ID_TOKEN ? "inline-flex" : "none";

      // Role switch only when signed in
      document.getElementById("btnRole").style.display = HAS_AUTH && ID_TOKEN ? "inline-flex" : "none";

      // Message
      const msg = document.getElementById("authMsg");
      if (!HAS_AUTH) {
        msg.textContent = "Public demo: viewing is open. Uploads are disabled.";
      } else if (!ID_TOKEN) {
        msg.textContent = "Sign in to upload.";
      } else {
        msg.textContent = (role === "Creator") ? "You can upload videos." : "Switch to Creator to upload.";
      }
    }

    async function fetchJSON(url, opts){
      const res = await fetch(url, opts);
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      return res.json();
    }

    // --- Auth wiring (only if HAS_AUTH = true) ---
    async function setupAuthIfEnabled(){
      // Ask server if auth is enabled
      try {
        const status = await fetchJSON("/auth/status");
        HAS_AUTH = !!status.hasAuth;
      } catch {
        HAS_AUTH = false;
      }

      // When auth OFF → just render guest UI
      if (!HAS_AUTH) {
        renderAuthUI();
        return;
      }

      // Auth ON → dynamically load MSAL and wire up
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js";
        s.onload = resolve;
        s.onerror = () => reject(new Error("Failed to load MSAL"));
        document.head.appendChild(s);
      });

      const CLIENT_ID = "ade4f251-cf4f-426b-a7dc-f9f19fce156c";   // your front-end app id (public)
      const AUTHORITY = "https://login.microsoftonline.com/common";
      const SCOPES = ["openid","profile","email"];
      const REDIRECT = window.location.origin;

      const msalInstance = new msal.PublicClientApplication({
        auth:{ clientId: CLIENT_ID, authority: AUTHORITY, redirectUri: REDIRECT },
        cache:{ cacheLocation:"localStorage" }
      });

      const LS_KEY="AUREVO_ID_TOKEN";
      ID_TOKEN = localStorage.getItem(LS_KEY) || null;

      async function refreshMe(){
        try{
          const res = await fetch("/me", { headers: ID_TOKEN ? { Authorization: "Bearer " + ID_TOKEN } : {} });
          if (res.ok) ME = (await res.json()).user; else ME = null;
        } catch{ ME = null; }
      }

      async function signIn(){
        try{
          const login = await msalInstance.loginPopup({ scopes: SCOPES });
          const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes: SCOPES });
          ID_TOKEN = token.idToken;
          localStorage.setItem(LS_KEY, ID_TOKEN);
          await refreshMe(); renderAuthUI();
        }catch(e){ alert("Sign in failed: " + e.message); }
      }

      async function signOut(){
        try{ await msalInstance.logoutPopup(); }catch(_){}
        localStorage.removeItem(LS_KEY);
        ID_TOKEN=null; ME=null; renderAuthUI();
      }

      async function switchRole(){
        if(!ME) return alert("Sign in first");
        const target = ME.role === "Creator" ? "Consumer" : "Creator";
        const res = await fetch("/me/role", {
          method:"POST",
          headers:{ Authorization:"Bearer "+ID_TOKEN, "Content-Type":"application/json" },
          body: JSON.stringify({ role: target })
        });
        if(res.ok){ await refreshMe(); renderAuthUI(); } else { alert("Role change failed"); }
      }

      // Expose for other handlers
      window.__auth = { signIn, signOut, switchRole, refreshMe };

      // If we already have a token, try to hydrate user
      if (ID_TOKEN) await refreshMe();

      renderAuthUI();
    }

    // --- Sidebar / Hamburger controller (open/close + ESC + focus trap) ---
    (function (){
      const body = document.body;
      const sidenav  = document.getElementById('sidenav');
      const scrim    = document.getElementById('scrim');
      const btnOpen  = document.getElementById('navToggle');
      const btnClose = document.getElementById('sideClose');
      const linksWrap= document.getElementById('sideNavLinks');

      const focusablesSel = 'a, button, [tabindex]:not([tabindex="-1"])';
      let lastFocused = null;

      function firstFocusable(){ return sidenav.querySelector(focusablesSel); }
      function allFocusable(){
        return Array.from(sidenav.querySelectorAll(focusablesSel)).filter(el=>!el.disabled && el.offsetParent!==null);
      }

      function openMenu(){
        lastFocused = document.activeElement;
        body.classList.add('nav-open');
        sidenav.setAttribute('aria-hidden','false');
        scrim.setAttribute('aria-hidden','false');
        btnOpen.setAttribute('aria-expanded','true');
        (firstFocusable() || btnClose).focus();
      }
      function closeMenu(){
        body.classList.remove('nav-open');
        sidenav.setAttribute('aria-hidden','true');
        scrim.setAttribute('aria-hidden','true');
        btnOpen.setAttribute('aria-expanded','false');
        (lastFocused || btnOpen).focus();
      }

      btnOpen.addEventListener('click', openMenu);
      btnClose.addEventListener('click', closeMenu);
      scrim.addEventListener('click', closeMenu);

      // Close after clicking any link inside sidebar
      linksWrap.addEventListener('click', (e)=>{
        const t = e.target.closest('a,button');
        if(!t) return;

        if (t.id === 'leftSignIn'){
          e.preventDefault();
          if (!HAS_AUTH) { alert("Sign-in is disabled on this public demo."); closeMenu(); return; }
          window.__auth?.signIn().then(closeMenu);
          return;
        }
        if (t.id === 'leftSignOut'){
          e.preventDefault();
          if (!HAS_AUTH) { closeMenu(); return; }
          window.__auth?.signOut(); closeMenu(); return;
        }
        closeMenu(); // normal nav
      });

      // ESC to close + focus trap
      document.addEventListener('keydown', (e)=>{
        if (e.key === 'Escape' && body.classList.contains('nav-open')) { e.preventDefault(); closeMenu(); }
        if (e.key === 'Tab' && body.classList.contains('nav-open')){
          const f = allFocusable();
          if (f.length === 0) return;
          const first = f[0], last = f[f.length-1];
          if (e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
      });

      // Initial wiring on load
      document.addEventListener('DOMContentLoaded', async ()=>{
        // Role switch button (works only when auth ON)
        document.getElementById("btnRole").onclick = ()=> {
          if (!HAS_AUTH) return alert("Roles are disabled on this public demo.");
          window.__auth?.switchRole();
        };

        await setupAuthIfEnabled();   // sets HAS_AUTH and wires MSAL if needed
        renderAuthUI();

        // Render latest videos
        try{
          const res = await fetch("/videos",{headers:{"Accept":"application/json"}});
          if(res.ok){ const data=await res.json(); renderLatest(data); }
        }catch{}
      });
    })();

    // Latest videos rendering
    function renderLatest(videos){
      const box=document.getElementById("latest");
      const status=document.getElementById("latestStatus");
      if(!videos||!videos.length){status.textContent="No uploaded videos yet."; box.innerHTML=""; return;}
      status.textContent="";
      box.innerHTML=videos.map(v=>`
        <article class="card">
          <video class="player" src="${v.playbackUrl}" controls></video>
          <h3>${v.title||"Untitled"}</h3>
        </article>`).join("");
    }
  </script>
</body>
</html>
