<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>aurevo — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=9" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0b1120; --bg-2:#10172a;
      --panel:#111827; --surface:#0e1530;
      --text:#e8eefc; --muted:#a9b6d3;
      --primary:#db144c; --accent:#f59e0b;
      --danger:#b91c1c; --outline:#28427a; --border:#1e2a46;
      --shadow:0 10px 26px rgba(0,0,0,.45); --r:14px;
    }
    *,*:before,*:after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg-2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Poppins',Arial,sans-serif}
    a{color:inherit;text-decoration:none}

    .shell{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidenav{position:sticky;top:0;align-self:start;background:var(--surface);border-right:1px solid var(--border);padding:20px 16px;min-height:100vh}
    .brand{display:flex;align-items:center;gap:.5rem;margin-bottom:14px;font-weight:800;letter-spacing:.3px;font-size:1.35rem}
    .brand i{color:var(--accent);font-size:1.5rem}
    .nav{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .nav a{display:flex;align-items:center;gap:.8rem;padding:12px 12px;border-radius:12px;color:var(--text)}
    .nav a:hover{background:#0f1a36}
    .nav a.active{background:var(--panel);box-shadow:var(--shadow)}
    .nav .section{margin-top:10px;color:var(--muted);font-size:.85rem}

    .btn{display:inline-flex;gap:.45rem;align-items:center;padding:9px 12px;background:var(--primary);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(1.05)}
    .btn.ghost{background:transparent;border:1px solid var(--outline)}
    .btn.accent{background:var(--accent);color:#111827}
    .btn.danger{background:var(--danger)}
    .btn.full{width:100%;justify-content:center}

    .sidenav .actions{margin-top:auto;display:grid;gap:8px;padding-top:16px}

    .main{min-width:0;display:flex;flex-direction:column}
    .topbar{display:flex;align-items:center;gap:10px;justify-content:flex-end;padding:14px 18px;background:transparent;border-bottom:1px solid var(--border)}
    .rolebox{display:flex;align-items:center;gap:10px;background:var(--panel);padding:8px 10px;border-radius:999px;box-shadow:var(--shadow);font-weight:700}
    .rolebox .avatar{width:32px;height:32px;border-radius:50%;object-fit:cover}
    .container{max-width:1100px;margin:20px auto;padding:0 18px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    .actionsRow{display:flex;gap:10px;margin-top:10px}
    .grid-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    .player{width:100%;aspect-ratio:16/9;border-radius:12px}
    .footer{color:var(--muted);text-align:center;padding:24px 12px;border-top:1px solid var(--border);margin-top:26px}

    @media (max-width: 860px){
      .shell{grid-template-columns:1fr}
      .sidenav{position:static;min-height:auto;border-right:none;border-bottom:1px solid var(--border)}
      .nav{flex-direction:row;flex-wrap:wrap}
      .nav a{border-radius:8px}
      .sidenav .actions{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- ========== LEFT NAV ========== -->
    <aside class="sidenav">
      <div class="brand">
        <span>aurevo</span> <i class="ri-play-fill"></i>
      </div>

      <nav class="nav">
        <a class="active"><i class="ri-home-4-line"></i> Home</a>
        <a href="/videos.html"><i class="ri-movie-2-line"></i> All Videos</a>
        <a id="uploadLink" href="/upload.html"><i class="ri-upload-2-line"></i> My Uploads</a>
        <div class="section">Account</div>
        <a class="ghost" href="#" id="leftSignIn"><i class="ri-login-circle-line"></i> Sign in</a>
      </nav>

      <div class="actions">
        <button class="btn full accent" id="ctaUpload"><i class="ri-add-line"></i> Upload</button>
        <button class="btn full danger" id="leftSignOut" style="display:none"><i class="ri-logout-circle-r-line"></i> Sign out</button>
      </div>
    </aside>

    <!-- ========== MAIN CONTENT ========== -->
    <div class="main">
      <header class="topbar">
        <div class="rolebox">
          <span id="roleBadge">Guest</span>
          <button id="btnRole" class="btn ghost" type="button" title="Switch role" style="display:none"><i class="ri-exchange-line"></i></button>
          <img class="avatar" src="https://images.unsplash.com/photo-1544723795-3fb6469f5b39?q=80&w=100&auto=format&fit=crop" alt="">
        </div>

        <!-- Upload button in navbar (always visible; click-guarded) -->
        <a id="btnUploadNav" class="btn ghost" href="/upload.html">
          <i class="ri-upload-2-line"></i> Upload
        </a>

        <button id="btnSignIn"  class="btn accent"  type="button">Sign in</button>
        <button id="btnSignOut" class="btn danger"  type="button" style="display:none">Sign out</button>
      </header>

      <main class="container">
        <section class="card">
          <h2 style="margin:0 0 8px">Welcome to aurevo</h2>
          <p class="muted" style="margin:0">
            Explore the latest videos. Creators can upload with Title, Publisher, Producer, Genre and Age rating.
          </p>
          <div class="actionsRow">
            <a class="btn" href="/videos.html"><i class="ri-play-circle-line"></i> Browse All</a>
            <!-- Always visible; click-guarded -->
            <a class="btn ghost" id="ctaUploadTop" href="/upload.html"><i class="ri-upload-cloud-2-line"></i> Upload</a>
          </div>
          <p id="authMsg" class="muted" style="margin-top:8px"></p>
        </section>

        <section class="card" style="margin-top:14px">
          <h2 style="margin-top:0">Latest videos</h2>
          <div id="latest" class="grid-cards"></div>
          <p id="latestStatus" class="muted"></p>
        </section>
      </main>

      <footer class="footer">© aurevo</footer>
    </div>
  </div>

  <!-- ========== AUTH / APP SCRIPTS ========== -->
  <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
  <script>
    /* MSAL config – replace with your real values */
    const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd";
    const CLIENT_ID = "e20305aa-c3a6-438e-80a0-6e0e92434fc2";

    const msalInstance = new msal.PublicClientApplication({
      auth: { clientId: CLIENT_ID, authority: `https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
      cache: { cacheLocation: "localStorage" }
    });

    const LS_KEY = "AUREVO_ID_TOKEN";
    let ID_TOKEN = localStorage.getItem(LS_KEY) || null;
    let ME = null; // { name, email, role }

    function authz(extra={}) {
      const t = ID_TOKEN || localStorage.getItem(LS_KEY) || "";
      return t ? { ...extra, Authorization: `Bearer ${t}` } : extra;
    }

    async function signIn(){
      try{
        const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
        const account = login.account;
        const token = await msalInstance.acquireTokenSilent({ account, scopes:["openid","profile","email"] });
        ID_TOKEN = token.idToken;
        localStorage.setItem(LS_KEY, ID_TOKEN);
        await refreshMe();
        renderAuthUI();
      }catch(e){
        console.error(e);
        document.getElementById("authMsg").textContent = "Sign in failed: " + (e.message||e);
      }
    }
    async function signOut(){
      try{
        const account = msalInstance.getAllAccounts()[0];
        localStorage.removeItem(LS_KEY); ID_TOKEN=null; ME=null;
        await msalInstance.logoutPopup({ account });
      }catch{}
      renderAuthUI();
    }

    async function refreshMe(){
      try{
        const res = await fetch("/me", { headers: authz({ "Accept":"application/json" }) });
        if (!res.ok){ ME=null; return; }
        const data = await res.json();
        ME = data.user || null;
      }catch{ ME=null; }
    }

    async function switchRole(){
      if (!ME) return alert("Sign in first.");
      const target = (ME.role === "Creator") ? "Consumer" : "Creator";
      try{
        const res = await fetch("/me/role", { method:"POST", headers: authz({ "Content-Type":"application/json" }), body: JSON.stringify({ role: target }) });
        if (!res.ok){ return alert("Role change failed: " + await res.text()); }
        await refreshMe(); renderAuthUI();
      }catch(e){ alert("Role change failed: " + e.message); }
    }

    // === NEW: Always show upload buttons; guard on click ===
    function renderAuthUI(){
      const signed = !!(ID_TOKEN || localStorage.getItem(LS_KEY));
      const role = ME?.role || "Guest";
      const canUpload = (role === "Creator");   // permission
      const showUploadButton = true;            // visibility

      document.getElementById("roleBadge").textContent = role;

      // top buttons
      document.getElementById("btnSignIn").style.display  = signed ? "none" : "inline-flex";
      document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
      document.getElementById("btnRole").style.display    = signed ? "inline-flex" : "none";

      // left quick buttons
      document.getElementById("leftSignIn").style.display  = signed ? "none" : "inline-flex";
      document.getElementById("leftSignOut").style.display = signed ? "inline-flex" : "none";

      // upload visibility (left + hero + navbar) — always visible now
      document.getElementById("uploadLink").style.display   = showUploadButton ? "inline-flex" : "none";
      document.getElementById("ctaUpload").style.display     = showUploadButton ? "inline-flex" : "none";
      document.getElementById("ctaUploadTop").style.display  = showUploadButton ? "inline-flex" : "none";
      document.getElementById("btnUploadNav").style.display  = showUploadButton ? "inline-flex" : "none";

      document.getElementById("authMsg").textContent =
        signed ? (canUpload ? "You can upload videos." : "Switch to Creator to upload.")
               : "Sign in to rate, comment, or upload.";
    }

    function requireCreator(e){
      if (!(ME && ME.role === "Creator")) {
        e.preventDefault();
        alert("Sign in and switch to Creator to upload.");
        return false;
      }
      return true;
    }

    // wire up buttons (top + left)
    document.getElementById("btnSignIn").addEventListener("click", signIn);
    document.getElementById("btnSignOut").addEventListener("click", signOut);
    document.getElementById("btnRole").addEventListener("click", switchRole);
    document.getElementById("leftSignIn").addEventListener("click", (e)=>{e.preventDefault(); signIn();});
    document.getElementById("leftSignOut").addEventListener("click", (e)=>{e.preventDefault(); signOut();});

    // click-guards on all Upload entry points
    document.getElementById("btnUploadNav").addEventListener("click", (e)=>{ requireCreator(e); });
    document.getElementById("ctaUploadTop").addEventListener("click", (e)=>{ requireCreator(e); });
    document.getElementById("uploadLink").addEventListener("click", (e)=>{ requireCreator(e); });
    document.getElementById("ctaUpload").addEventListener("click", (e)=>{ requireCreator(e); });

    // boot
    (async ()=>{ renderAuthUI(); if (ID_TOKEN){ await refreshMe(); renderAuthUI(); } })();
  </script>

  <script>
    /* ===== Latest videos section ===== */
    const esc = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#39;");

    function ytId(url=''){
      try{
        const u = new URL(url);
        if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
        if (u.hostname.includes('youtube.com')){
          if (u.searchParams.get('v')) return u.searchParams.get('v');
          const p = u.pathname.split('/'); const i = p.indexOf('embed');
          if (i !== -1 && p[i+1]) return p[i+1];
        }
      }catch{}
      return null;
    }
    function ytEmbed(id){
      const src = `https://www.youtube.com/embed/${id}?rel=0&modestbranding=1&playsinline=1`;
      return `<iframe class="player" src="${src}" title="YouTube player" frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen referrerpolicy="strict-origin-when-cross-origin"></iframe>`;
    }

    function renderLatest(items){
      const box = document.getElementById('latest');
      const status = document.getElementById('latestStatus');

      const latest = (Array.isArray(items)?items:[])
        .slice()
        .sort((a,b)=>new Date(b.createdAt||0)-new Date(a.createdAt||0))
        .slice(0,6);

      if (!latest.length){ status.textContent='No videos yet.'; box.innerHTML=''; return; }

      status.textContent='';
      box.innerHTML = latest.map(v=>{
        const id = ytId(v.playbackUrl||'');
        const player = id ? ytEmbed(id)
                          : (v.playbackUrl ? `<video class="player" src="${esc(v.playbackUrl)}" controls preload="metadata"></video>` : '');
        return `<article class="card">
          ${player}
          <h3 style="margin:8px 0 4px">${esc(v.title||'Untitled')}</h3>
          <p class="muted" style="margin:0">${esc(v.publisher||'')}</p>
        </article>`;
      }).join('');
    }

    (async ()=>{
      const status = document.getElementById('latestStatus');
      try{
        const res = await fetch('/videos?ts='+Date.now(), { headers:{'Accept':'application/json','Cache-Control':'no-cache'} });
        const txt = await res.text();
        if (!res.ok){ status.textContent = `HTTP ${res.status}: ${txt.slice(0,160)}`; return; }
        let data; try{ data = JSON.parse(txt); }catch{ status.textContent='Invalid JSON'; return; }
        renderLatest(data);
      }catch(e){
        status.textContent = 'Could not load latest videos: '+e.message;
        console.error(e);
      }
    })();
  </script>
</body>
</html>
