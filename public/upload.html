<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aurevo — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=14" />

  <!-- OPTIONAL: Azure Blob container SAS (for desktop uploads) -->
  <meta name="blob-container-sas" content="" />

  <style>
    :root{
      --bg:#00d2ff; --bg-2:#ff6a00;
      --panel:#111827; --surface:#0e1530;
      --text:#e8eefc; --muted:#a9b6d3;
      --accent:#f59e0b; --danger:#b91c1c; --border:#1e2a46;
      --shadow:0 10px 26px rgba(0,0,0,.45); --r:14px;
    }
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg-2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Poppins,sans-serif;}
    header.nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--surface);border-bottom:1px solid var(--border);}
    .container{max-width:900px;margin:24px auto;padding:0 14px;}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:var(--shadow);}
    .muted{color:var(--muted);}
    .field{display:grid;gap:6px;margin:10px 0}
    .field input{padding:8px 10px;border:1px solid var(--border);background:#0a0f20;color:var(--text);border-radius:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;background:var(--accent);color:#111827;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    .btn.secondary{background:#0f1a36;color:var(--text);}
    .btn.danger{background:var(--danger);color:#fff;}
    .badge{font-size:12px;padding:2px 8px;background:#13213b;color:var(--muted);border-radius:999px}
    .small{font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px dashed var(--border)}
    .progress-wrap{display:none;align-items:center;gap:8px}
    .progress{appearance:none;width:220px;height:10px;border-radius:999px;overflow:hidden;background:#14213d}
    .progress::-webkit-progress-value{background:#3b82f6}
    .progress::-moz-progress-bar{background:#3b82f6}
    footer{ text-align:center; color:var(--muted); padding:24px 12px; border-top:1px solid var(--border); margin-top:28px; }
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/" style="color:inherit;text-decoration:none">Aurevo</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span class="badge" id="roleBadge">Guest</span>
    <button id="btnRole"  class="btn secondary" type="button" style="display:none">Switch Role</button>
    <button id="btnSignIn"  class="btn"          type="button">Sign in</button>
    <button id="btnSignOut" class="btn danger"   type="button" style="display:none">Sign out</button>
    <a class="btn secondary" href="/videos.html">All Videos</a>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2>Upload a New Video</h2>

    <div id="gateMsg" class="muted" style="display:none">
      You must be signed in as <b>Creator</b> to upload. Use “Sign in”, then “Switch Role”.
    </div>

    <form id="formWrap" style="display:none;max-width:680px">
      <div class="field"><label>Title</label><input id="title" placeholder="e.g., Yoga Basics" /></div>
      <div class="row">
        <div class="field" style="flex:1 1 230px"><label>Publisher</label><input id="publisher" /></div>
        <div class="field" style="flex:1 1 230px"><label>Producer</label><input id="producer" /></div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px"><label>Genre</label><input id="genre" /></div>
        <div class="field" style="flex:1 1 230px"><label>Age Rating</label><input id="age" /></div>
      </div>

      <div class="field">
        <label>Playback URL (YouTube or Blob URL)</label>
        <input id="playbackUrl" placeholder="https://..." />
      </div>

      <div id="blobArea" class="field" style="display:none">
        <label>Upload from Desktop <span class="pill small">Azure Blob</span></label>
        <div class="row">
          <input id="filePick" type="file" accept="video/*" />
          <button id="btnBlobUpload" class="btn" type="button">Upload Video File</button>
          <span id="blobStatus" class="muted small"></span>
        </div>
        <div class="progress-wrap" id="progressWrap">
          <progress id="prog" class="progress" max="100" value="0"></progress>
          <span id="progText" class="small muted">0%</span>
        </div>
        <div class="small muted">After upload, the <b>Playback URL</b> will be filled automatically.</div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnSubmit" type="submit">Save to Aurevo</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </section>
</main>

<footer>© Aurevo</footer>

<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
  const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72babec755dd";
  const CLIENT_ID = "ade4f251-cf4f-426b-a7dc-f9f19fce156c";

  const msalInstance = new msal.PublicClientApplication({
    auth:{ clientId: CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
    cache:{ cacheLocation:"localStorage" }
  });

  const LS_KEY="AUREVO_ID_TOKEN";
  let ID_TOKEN=localStorage.getItem(LS_KEY)||null, ME=null;

  const authz = (extra={}) => {
    const t=ID_TOKEN||localStorage.getItem(LS_KEY)||"";
    return t?{...extra,Authorization:`Bearer ${t}`} : extra;
  };

  async function signIn(){ try{
    const login=await msalInstance.loginPopup({scopes:["openid","profile","email"]});
    const token=await msalInstance.acquireTokenSilent({account:login.account,scopes:["openid","profile","email"]});
    ID_TOKEN=token.idToken; localStorage.setItem(LS_KEY,ID_TOKEN);
    await refreshMe(); renderAuthUI(); gateUI();
  }catch(e){ alert("Sign in failed: "+(e.message||e)); } }

  async function signOut(){ localStorage.removeItem(LS_KEY); ID_TOKEN=null; ME=null;
    try{ await msalInstance.logoutPopup(); }catch{} renderAuthUI(); gateUI(); }

  async function refreshMe(){ try{
    const res=await fetch("/me",{headers:authz({Accept:"application/json"})});
    ME=res.ok?(await res.json()).user:null;
  }catch{ME=null;} updateRoleBadge(); }

  function updateRoleBadge(){
    document.getElementById("roleBadge").textContent=ME?ME.role:"Guest";
    document.getElementById("btnRole").style.display=ME?"inline-flex":"none";
  }

  async function switchRole(){
    if(!ME) return alert("Sign in first");
    const target=ME.role==="Creator"?"Consumer":"Creator";
    const res=await fetch("/me/role",{method:"POST",headers:authz({"Content-Type":"application/json"}),body:JSON.stringify({role:target})});
    if(!res.ok){return alert("Role change failed: "+await res.text());}
    await refreshMe(); gateUI();
  }

  function renderAuthUI(){
    const signed=!!(ID_TOKEN||localStorage.getItem(LS_KEY));
    document.getElementById("btnSignIn").style.display=signed?"none":"inline-flex";
    document.getElementById("btnSignOut").style.display=signed?"inline-flex":"none";
    updateRoleBadge();
  }

  function gateUI(){
    const isCreator=!!(ME&&ME.role==="Creator");
    document.getElementById("formWrap").style.display=isCreator?"block":"none";
    document.getElementById("gateMsg").style.display=isCreator?"none":"block";
  }

  // ====== Save metadata ======
  async function submitForm(e){
    e.preventDefault();
    const status=document.getElementById("status");
    const body={
      title:document.getElementById("title").value.trim(),
      publisher:document.getElementById("publisher").value.trim(),
      producer:document.getElementById("producer").value.trim(),
      genre:document.getElementById("genre").value.trim(),
      age:document.getElementById("age").value.trim(),
      playbackUrl:document.getElementById("playbackUrl").value.trim(),
      external:true
    };
    if(!body.title||!body.playbackUrl){status.textContent="Title and Playback URL required.";return;}
    try{
      document.getElementById("btnSubmit").disabled=true;
      status.textContent="Saving…";
      const res=await fetch("/videos",{method:"POST",headers:{...authz({"Content-Type":"application/json"})},body:JSON.stringify(body)});
      if(!res.ok){status.textContent="Save failed "+res.status;return;}
      status.textContent="Saved ✓ (see All Videos)";
    }catch(e){status.textContent="Save error: "+e.message;}
    finally{document.getElementById("btnSubmit").disabled=false;}
  }

  // ===== Blob upload (optional) =====
  const containerSas=(document.querySelector('meta[name="blob-container-sas"]')?.content||'').trim();
  const blobArea=document.getElementById("blobArea");
  if(containerSas) blobArea.style.display="block";

  function parseContainerInfo(sas){try{const u=new URL(sas);const acc=u.hostname.split('.')[0];const cont=u.pathname.split('/')[1];return{base:`https://${acc}.blob.core.windows.net/${cont}`,query:u.search};}catch{return null;}}

  function putWithProgress(url,file,headers,onProg){return new Promise((res,rej)=>{const xhr=new XMLHttpRequest();xhr.open("PUT",url,true);Object.entries(headers).forEach(([k,v])=>xhr.setRequestHeader(k,v));xhr.upload.onprogress=(e)=>{if(e.lengthComputable)onProg(Math.round((e.loaded/e.total)*100));};xhr.onload=()=>xhr.status>=200&&xhr.status<300?res():rej(new Error("Blob upload failed"));xhr.onerror=()=>rej(new Error("Network error"));xhr.send(file);});}

  async function uploadToBlob(file,onProg){const info=parseContainerInfo(containerSas);if(!info)throw new Error("Bad SAS");const safe=Date.now()+"_"+file.name;const url=`${info.base}/${encodeURIComponent(safe)}${info.query}`;await putWithProgress(url,file,{"x-ms-blob-type":"BlockBlob"},onProg);return `${info.base}/${encodeURIComponent(safe)}`;}

  document.addEventListener("DOMContentLoaded",()=>{
    renderAuthUI(); if(ID_TOKEN) refreshMe().then(gateUI); else gateUI();
    document.getElementById("btnSignIn").addEventListener("click",signIn);
    document.getElementById("btnSignOut").addEventListener("click",signOut);
    document.getElementById("btnRole").addEventListener("click",switchRole);
    document.getElementById("formWrap").addEventListener("submit",submitForm);

    if(blobArea.style.display!=="none"){
      const f=document.getElementById("filePick"),stat=document.getElementById("blobStatus"),prog=document.getElementById("prog"),wrap=document.getElementById("progressWrap"),pt=document.getElementById("progText");
      document.getElementById("btnBlobUpload").addEventListener("click",async()=>{
        const file=f.files?.[0]; if(!file){stat.textContent="Pick a file";return;}
        if(!ME||ME.role!=="Creator"){stat.textContent="Sign in as Creator";return;}
        try{
          wrap.style.display="flex";prog.value=0;pt.textContent="0%";
          const url=await uploadToBlob(file,(pct)=>{prog.value=pct;pt.textContent=pct+"%";});
          document.getElementById("playbackUrl").value=url;
          stat.textContent="Uploaded ✓ (now Save)";
        }catch(e){stat.textContent=e.message;}finally{setTimeout(()=>wrap.style.display="none",800);}
      });
    }
  });
</script>
</body>
</html>
