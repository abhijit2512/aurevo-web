<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>aurevo — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=10" />
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">

  <!-- Optional: Desktop uploads straight to Azure Blob via Container SAS.
       Put your SAS URL to the *videos* container to show the file picker UI.
       Example: https://<account>.blob.core.windows.net/videos?<SAS>
       Leave content empty to hide the desktop upload block. -->
  <meta name="blob-container-sas" content="" />

  <style>
    /* ===== aurevo dark theme (same vibe as index.html) ===== */
    :root{
      --bg:#0b1120; --bg-2:#10172a;
      --panel:#111827; --surface:#0e1530;
      --text:#e8eefc; --muted:#a9b6d3;
      --primary:#db144c;       /* deep pink */
      --accent:#f59e0b;        /* gold */
      --danger:#b91c1c; --outline:#28427a; --border:#1e2a46;
      --shadow:0 10px 26px rgba(0,0,0,.45); --r:14px;
    }
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg-2));color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Poppins',Arial,sans-serif}

    /* Top nav */
    header.nav{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:transparent}
    header.nav h1{margin:0;font-size:1.1rem;font-weight:800;letter-spacing:.2px}
    header.nav a{color:inherit;text-decoration:none}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:9px 12px;border-radius:10px;border:1px solid transparent;background:var(--primary);color:#fff;cursor:pointer;font-weight:600}
    .btn.ghost{background:transparent;border-color:var(--outline)}
    .btn.accent{background:var(--accent);color:#111827}
    .btn.danger{background:var(--danger)}
    .badge{display:inline-flex;align-items:center;gap:6px;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:6px 10px;box-shadow:var(--shadow);font-weight:700}
    .badge i{color:var(--accent)}

    /* Page */
    .container{max-width:900px;margin:26px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--r);padding:18px;box-shadow:var(--shadow)}
    .muted{color:var(--muted)}
    .field{display:grid;gap:6px;margin:10px 0}
    input[type="text"],input:not([type]),input[type="url"],input[type="number"]{
      padding:10px 12px;border:1px solid var(--outline);border-radius:10px;background:#0a1330;color:var(--text)
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .field{flex:1 1 260px}
    .small{font-size:.85rem}
    .pill{padding:2px 8px;border-radius:999px;border:1px dashed var(--outline)}
    .progress-wrap{display:none;align-items:center;gap:8px;margin-top:6px}
    progress{appearance:none;width:240px;height:10px;border-radius:999px;overflow:hidden;background:#14213d}
    progress::-webkit-progress-bar{background:#14213d}
    progress::-webkit-progress-value{background:#3b82f6}
    progress::-moz-progress-bar{background:#3b82f6}
    footer{color:var(--muted);text-align:center;padding:24px 12px;border-top:1px solid var(--border);margin-top:28px}
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/">aurevo</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span class="badge"><i class="ri-user-3-line"></i><span id="roleBadge">Guest</span></span>
    <button id="btnRole"  class="btn ghost"  type="button" style="display:none" title="Switch role"><i class="ri-exchange-line"></i> Switch</button>
    <a class="btn ghost" href="/videos.html"><i class="ri-movie-2-line"></i> All Videos</a>
    <button id="btnSignIn"  class="btn accent" type="button"><i class="ri-login-circle-line"></i> Sign in</button>
    <button id="btnSignOut" class="btn danger" type="button" style="display:none"><i class="ri-logout-circle-r-line"></i> Sign out</button>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2 style="margin:0 0 8px">Upload a New Video</h2>

    <!-- Non-creator gate -->
    <p id="gateMsg" class="muted" style="display:none;margin-top:6px">
      You must be signed in as <b>Creator</b> to upload. Sign in, then use <b>Switch</b> to toggle to Creator.
    </p>

    <!-- Creator-only form -->
    <form id="formWrap" style="display:none;max-width:720px">
      <div class="field">
        <label>Title</label>
        <input id="title" placeholder="e.g., Algebra Basics" />
      </div>

      <div class="row">
        <div class="field">
          <label>Publisher</label>
          <input id="publisher" placeholder="Publisher" />
        </div>
        <div class="field">
          <label>Producer</label>
          <input id="producer" placeholder="Producer" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Genre</label>
          <input id="genre" placeholder="e.g., education" />
        </div>
        <div class="field">
          <label>Age Rating</label>
          <input id="age" placeholder="e.g., 13+" />
        </div>
      </div>

      <!-- A) Paste a public playback URL (YouTube or direct blob URL) -->
      <div class="field">
        <label>Playback URL (YouTube link or direct MP4/WebM/Ogg URL)</label>
        <input id="playbackUrl" placeholder="https://… (YouTube or blob URL)" />
      </div>

      <!-- B) Optional desktop upload to Azure Blob (shown only if meta SAS present) -->
      <div id="blobArea" class="field" style="display:none">
        <label>Upload from Desktop <span class="pill small">Azure Blob</span></label>
        <div class="row" style="align-items:center">
          <input id="filePick" type="file" accept="video/*" />
          <button id="btnBlobUpload" class="btn" type="button"><i class="ri-upload-2-line"></i> Upload Video File</button>
          <span id="blobStatus" class="muted small"></span>
        </div>

        <div class="progress-wrap" id="progressWrap">
          <progress id="prog" max="100" value="0"></progress>
          <span id="progText" class="small muted">0%</span>
        </div>

        <p class="small muted" style="margin:8px 0 0">
          After upload, the <b>Playback URL</b> will be filled automatically.
          (Container access level must be <i>Blob (anonymous read)</i>.)
        </p>
      </div>

      <div class="row" style="margin-top:10px;align-items:center">
        <button id="btnSubmit" class="btn" type="submit"><i class="ri-save-line"></i> Save to aurevo</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </section>
</main>

<footer>© aurevo</footer>

<!-- MSAL (same version as index) -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
  // ===== Auth & role (match index.html) =====
  const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd";
  const CLIENT_ID = "e20305aa-c3a6-438e-80a0-6e0e92434fc2";

  const msalInstance = new msal.PublicClientApplication({
    auth:{ clientId: CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
    cache:{ cacheLocation:"localStorage" }
  });

  const LS_KEY = "AUREVO_ID_TOKEN"; // same as index.html
  let ID_TOKEN = localStorage.getItem(LS_KEY) || null;
  let ME = null; // {role,...}

  function authz(extra={}) {
    const t = ID_TOKEN || localStorage.getItem(LS_KEY) || "";
    return t ? { ...extra, Authorization:`Bearer ${t}` } : extra;
  }

  async function signIn(){
    try{
      const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
      const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes:["openid","profile","email"] });
      ID_TOKEN = token.idToken;
      localStorage.setItem(LS_KEY, ID_TOKEN);
      await refreshMe(); renderAuthUI(); gateUI();
    }catch(e){ alert("Sign in failed: "+(e.message||e)); }
  }
  async function signOut(){
    try{
      const account = msalInstance.getAllAccounts()[0];
      localStorage.removeItem(LS_KEY); ID_TOKEN=null; ME=null;
      await msalInstance.logoutPopup({ account });
    }catch{}
    renderAuthUI(); gateUI();
  }

  async function refreshMe(){
    try{
      const res = await fetch("/me",{ headers: authz({Accept:"application/json"}) });
      ME = res.ok ? (await res.json()).user : null;
    }catch{ ME=null; }
    updateRoleBadge();
  }

  function updateRoleBadge(){
    document.getElementById("roleBadge").textContent = ME?.role || "Guest";
    const btnRole = document.getElementById("btnRole");
    btnRole.style.display = ID_TOKEN ? "inline-flex" : "none";
    btnRole.title = ME?.role==="Creator" ? "Switch to Consumer" : "Switch to Creator";
  }

  async function switchRole(){
    if(!ME) return alert("Sign in first.");
    const target = ME.role==="Creator" ? "Consumer" : "Creator";
    const res = await fetch("/me/role", { method:"POST", headers: authz({"Content-Type":"application/json"}), body: JSON.stringify({ role: target }) });
    if(!res.ok) return alert("Role change failed: "+await res.text());
    await refreshMe(); gateUI();
  }

  function renderAuthUI(){
    const signed = !!(ID_TOKEN || localStorage.getItem(LS_KEY));
    document.getElementById("btnSignIn").style.display  = signed ? "none" : "inline-flex";
    document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
    updateRoleBadge();
  }

  function gateUI(){
    const isCreator = !!(ME && ME.role==="Creator");
    document.getElementById("formWrap").style.display = isCreator ? "block" : "none";
    document.getElementById("gateMsg").style.display  = isCreator ? "none"  : "block";
  }
</script>

<script>
  /* ===== Optional: Desktop upload to Azure Blob via Container SAS ===== */
  const containerSas = (document.querySelector('meta[name="blob-container-sas"]')?.content || '').trim();
  const blobArea = document.getElementById("blobArea");
  if (containerSas) blobArea.style.display = "block";

  function parseContainerInfo(url){
    try{
      const u = new URL(url);
      const account = u.hostname.split('.')[0];
      const container = u.pathname.replace(/^\//,'').split('/')[0];
      return { base:`https://${account}.blob.core.windows.net/${container}`, query:u.search };
    }catch{ return null; }
  }

  function putWithProgress(url, file, headers={}, onProgress=()=>{}){
    return new Promise((resolve,reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", url, true);
      Object.entries(headers).forEach(([k,v])=>xhr.setRequestHeader(k,v));
      xhr.upload.onprogress = (e)=>{
        if(e.lengthComputable){
          const pct = Math.round(100*e.loaded/e.total);
          onProgress(pct);
        }
      };
      xhr.onload = ()=> (xhr.status>=200 && xhr.status<300) ? resolve() : reject(new Error(`Blob upload failed: ${xhr.status}`));
      xhr.onerror = ()=> reject(new Error("Network error during blob upload"));
      xhr.send(file);
    });
  }

  async function uploadToBlobWithSas(file, onProgress){
    const info = parseContainerInfo(containerSas);
    if(!info) throw new Error("Invalid Container SAS URL.");
    const safe = Date.now()+"_"+file.name.replace(/[^\w.\- ]+/g,'_');
    const putUrl = `${info.base}/${encodeURIComponent(safe)}${info.query}`;
    await putWithProgress(putUrl, file, {
      "x-ms-blob-type":"BlockBlob",
      "x-ms-version":"2021-12-02",
      "Content-Type": file.type || "application/octet-stream"
    }, onProgress);
    // Public URL (container access level must allow anonymous read)
    return `${info.base}/${encodeURIComponent(safe)}`;
  }
</script>

<script>
  /* ===== Save metadata to aurevo API ===== */
  async function submitForm(e){
    e.preventDefault();
    const status = document.getElementById("status");
    status.textContent = "";

    if(!ME || ME.role!=="Creator"){ status.textContent="You must be Creator to upload."; return; }

    const body = {
      title:       document.getElementById("title").value.trim(),
      publisher:   document.getElementById("publisher").value.trim(),
      producer:    document.getElementById("producer").value.trim(),
      genre:       document.getElementById("genre").value.trim(),
      age:         document.getElementById("age").value.trim(),
      playbackUrl: document.getElementById("playbackUrl").value.trim(),
      external:    true
    };
    if(!body.title || !body.playbackUrl){ status.textContent="Title and Playback URL are required."; return; }

    try{
      document.getElementById("btnSubmit").disabled = true;
      status.textContent = "Saving…";
      const res = await fetch("/videos",{
        method:"POST",
        headers: { ...authz({"Content-Type":"application/json"}) },
        body: JSON.stringify(body)
      });
      const txt = await res.text();
      if(!res.ok){ status.textContent = `Save failed: ${res.status} ${res.statusText} — ${(txt||"").slice(0,180)}`; return; }
      status.textContent = "Saved ✓ (check All Videos)";
      // location.href = "/videos.html";
    }catch(e){
      status.textContent = "Save error: "+e.message;
    }finally{
      document.getElementById("btnSubmit").disabled = false;
    }
  }

  (async ()=>{
    // Auth + gate
    (document.getElementById("btnSignIn")).addEventListener("click", signIn);
    (document.getElementById("btnSignOut")).addEventListener("click", signOut);
    (document.getElementById("btnRole")).addEventListener("click", switchRole);
    (document.getElementById("formWrap")).addEventListener("submit", submitForm);

    renderAuthUI();
    if(ID_TOKEN){ await refreshMe(); }
    gateUI();

    // Wire blob uploader if enabled
    if(containerSas){
      const filePick = document.getElementById("filePick");
      const blobStatus = document.getElementById("blobStatus");
      const prog = document.getElementById("prog");
      const progWrap = document.getElementById("progressWrap");
      const progText = document.getElementById("progText");

      document.getElementById("btnBlobUpload").addEventListener("click", async ()=>{
        const file = filePick.files?.[0];
        if(!file){ blobStatus.textContent = "Choose a file first."; return; }
        if(!ME || ME.role!=="Creator"){ blobStatus.textContent = "Sign in as Creator to upload."; return; }

        try{
          blobStatus.textContent = "Uploading to Azure Blob…";
          progWrap.style.display = "flex"; prog.value = 0; progText.textContent = "0%";
          const url = await uploadToBlobWithSas(file, (pct)=>{ prog.value=pct; progText.textContent=pct+"%"; });

          // Fill playback URL + maybe title
          document.getElementById("playbackUrl").value = url;
          const tEl = document.getElementById("title");
          if(!tEl.value.trim()){
            const base = (file.name||"").split('.').slice(0,-1).join('.') || file.name;
            tEl.value = base.replace(/[_\-]+/g,' ').trim();
          }
          blobStatus.textContent = "Uploaded ✓ (now click Save)";
        }catch(e){
          blobStatus.textContent = e.message;
        }finally{
          setTimeout(()=>{ progWrap.style.display="none"; }, 900);
        }
      });
    }
  })();
</script>
</body>
</html>
