<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aurevo — Upload</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/style.css?v=15" />

  <!-- OPTIONAL: Desktop uploads to Azure Blob -->
  <meta name="blob-container-sas" content="https://<yourstorage>.blob.core.windows.net/aurevo-videos?<SAS>" />

  <style>
    /* Aurevo look: bright cyan + orange */
    :root{
      --brand-bg:linear-gradient(180deg, #00d2ff, #ff6a00);
      --brand-card:#111827;
      --brand-text:#e8eefc;
      --brand-muted:#9aa3b2;
      --brand-primary:#00bcd4;  /* cyan */
      --brand-secondary:#ff6a00;/* orange */
      --brand-accent:#f59e0b;
      --brand-danger:#b91c1c;
      --brand-outline:#1e2a46;
    }
    body{background:var(--brand-bg);color:var(--brand-text);}
    .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;background:#0e1530;border-bottom:1px solid var(--brand-outline);}
    .container{max-width:900px;margin:24px auto;padding:0 14px;}
    .card{background:var(--brand-card);border:1px solid var(--brand-outline);border-radius:14px;padding:16px;}
    .muted{color:var(--brand-muted)}
    .field{display:grid;gap:6px;margin:10px 0}
    .field input{padding:8px 10px;border:1px solid var(--brand-outline);background:#0a0f20;color:var(--brand-text);border-radius:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;background:var(--brand-primary);color:#fff;border:none;border-radius:8px;cursor:pointer}
    .btn.secondary{background:var(--brand-secondary)}
    .btn.danger{background:var(--brand-danger)}
    .badge{font-size:12px;padding:2px 8px;background:#13213b;color:#a9b6d3;border-radius:999px}
    .small{font-size:12px}
    .pill{padding:2px 8px;border-radius:999px;border:1px dashed var(--brand-outline)}
    .progress-wrap{display:none;align-items:center;gap:8px}
    .progress{appearance:none;width:220px;height:10px;border-radius:999px;overflow:hidden;background:#14213d}
    .progress::-webkit-progress-bar{background:#14213d}
    .progress::-webkit-progress-value{background:#3b82f6}
    .progress::-moz-progress-bar{background:#3b82f6}
    .footer{text-align:center;color:var(--brand-muted);padding:24px 12px;border-top:1px solid var(--brand-outline);margin-top:28px;}
  </style>
</head>
<body>
<header class="nav">
  <h1><a href="/" style="color:inherit;text-decoration:none">Aurevo</a></h1>
  <nav style="display:flex;gap:10px;align-items:center">
    <span class="badge" id="roleBadge">Guest</span>
    <button id="btnRole" class="btn secondary" type="button" style="display:none">Switch Role</button>
    <button id="btnSignIn" class="btn" type="button">Sign in</button>
    <button id="btnSignOut" class="btn danger" type="button" style="display:none">Sign out</button>
    <a class="btn secondary" href="/videos.html">All Videos</a>
  </nav>
</header>

<main class="container">
  <section class="card">
    <h2>Upload a New Video</h2>

    <div id="gateMsg" class="muted" style="display:none">
      You must be signed in as <b>Creator</b> to upload. Use “Sign in”, then “Switch Role” to become a Creator.
    </div>

    <form id="formWrap" style="display:none;max-width:680px">
      <div class="field">
        <label>Title</label>
        <input id="title" placeholder="e.g., Aurevo Tutorial" />
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Publisher</label>
          <input id="publisher" placeholder="Publisher" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Producer</label>
          <input id="producer" placeholder="Producer" />
        </div>
      </div>
      <div class="row">
        <div class="field" style="flex:1 1 230px">
          <label>Genre</label>
          <input id="genre" placeholder="Genre" />
        </div>
        <div class="field" style="flex:1 1 230px">
          <label>Age Rating</label>
          <input id="age" placeholder="e.g., 13+" />
        </div>
      </div>

      <div class="field">
        <label>Playback URL</label>
        <input id="playbackUrl" placeholder="https://... (YouTube or blob URL)" />
      </div>

      <div id="blobArea" class="field" style="display:none">
        <label>Upload from Desktop <span class="pill small">Azure Blob</span></label>
        <div class="row">
          <input id="filePick" type="file" accept="video/*" />
          <button id="btnBlobUpload" class="btn" type="button">Upload Video File</button>
          <span id="blobStatus" class="muted small"></span>
        </div>

        <div class="progress-wrap" id="progressWrap">
          <progress id="prog" class="progress" max="100" value="0"></progress>
          <span id="progText" class="small muted">0%</span>
        </div>
      </div>

      <div class="row" style="margin-top:6px">
        <button class="btn" id="btnSubmit" type="submit">Save to Aurevo</button>
        <span id="status" class="muted"></span>
      </div>
    </form>
  </section>
</main>

<footer class="footer">© Aurevo</footer>

<!-- MSAL -->
<script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
<script>
  // === Aurevo Auth Config ===
  const TENANT_ID = "b0e4c77a-c53c-4cbc-8f97-72baebc755dd"; // your tenant
  const CLIENT_ID = "ade4f251-cf4f-426b-a7dc-f9f19fce156c"; // Aurevo appId

  const msalInstance = new msal.PublicClientApplication({
    auth:{ clientId: CLIENT_ID, authority:`https://login.microsoftonline.com/${TENANT_ID}`, redirectUri: window.location.origin },
    cache:{ cacheLocation:"localStorage" }
  });

  const LS_KEY = "AUREVO_ID_TOKEN";
  let ID_TOKEN = localStorage.getItem(LS_KEY) || null;
  let ME = null;

  function authz(extra={}) {
    const t = ID_TOKEN || localStorage.getItem(LS_KEY) || "";
    return t ? { ...extra, Authorization:`Bearer ${t}` } : extra;
  }

  async function signIn(){
    try{
      const login = await msalInstance.loginPopup({ scopes:["openid","profile","email"] });
      const token = await msalInstance.acquireTokenSilent({ account: login.account, scopes:["openid","profile","email"]});
      ID_TOKEN = token.idToken;
      localStorage.setItem(LS_KEY, ID_TOKEN);
      await refreshMe(); renderAuthUI(); gateUI();
    }catch(e){ alert("Sign in failed: "+(e.message||e)); }
  }
  async function signOut(){
    localStorage.removeItem(LS_KEY); ID_TOKEN=null; ME=null;
    try{ await msalInstance.logoutPopup(); }catch{}
    renderAuthUI(); gateUI();
  }

  async function refreshMe(){
    try{
      const res = await fetch("/me",{ headers: authz({Accept:"application/json"})});
      ME = res.ok ? (await res.json()).user : null;
    }catch{ ME=null; }
    updateRoleBadge();
  }

  function updateRoleBadge(){
    const b = document.getElementById("roleBadge");
    b.textContent = ME ? ME.role : "Guest";
    const btnRole = document.getElementById("btnRole");
    btnRole.style.display = ME ? "inline-flex" : "none";
    btnRole.textContent = ME && ME.role==="Creator" ? "Switch to Consumer" : "Switch to Creator";
  }

  async function switchRole(){
    if(!ME) return alert("Please sign in first.");
    const target = ME.role==="Creator" ? "Consumer" : "Creator";
    const res = await fetch("/me/role",{ method:"POST", headers: authz({"Content-Type":"application/json"}), body: JSON.stringify({role:target}) });
    if(!res.ok){ return alert("Role change failed: "+(await res.text()).slice(0,200)); }
    await refreshMe(); gateUI();
  }

  function renderAuthUI(){
    const signed = !!(ID_TOKEN || localStorage.getItem(LS_KEY));
    document.getElementById("btnSignIn").style.display  = signed ? "none" : "inline-flex";
    document.getElementById("btnSignOut").style.display = signed ? "inline-flex" : "none";
    updateRoleBadge();
  }

  function gateUI(){
    const isCreator = !!(ME && ME.role==="Creator");
    document.getElementById("formWrap").style.display = isCreator ? "block" : "none";
    document.getElementById("gateMsg").style.display  = isCreator ? "none"  : "block";
  }

  // === Blob Upload ===
  const containerSas = (document.querySelector('meta[name="blob-container-sas"]')?.content || '').trim();
  const blobArea = document.getElementById("blobArea");
  if (containerSas && /^https?:\/\//i.test(containerSas)) blobArea.style.display = "block";

  function parseContainerInfo(containerSasUrl){
    try{
      const u = new URL(containerSasUrl);
      const account = u.hostname.split('.')[0];
      const container = u.pathname.replace(/^\//,'').split('/')[0];
      const qs = u.search;
      const base = `https://${account}.blob.core.windows.net/${container}`;
      return { account, container, query: qs, base };
    }catch{ return null; }
  }

  function putWithProgress(url, file, headers = {}, onProgress = ()=>{}){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open("PUT", url, true);
      Object.entries(headers).forEach(([k,v])=>xhr.setRequestHeader(k, v));
      xhr.upload.onprogress = (evt)=>{
        if (evt.lengthComputable){
          const pct = Math.round((evt.loaded/evt.total)*100);
          onProgress(pct);
        }
      };
      xhr.onload = ()=> (xhr.status >= 200 && xhr.status < 300) ? resolve(xhr.responseText) : reject(new Error(`Blob upload failed: ${xhr.status} ${xhr.statusText}`));
      xhr.onerror = ()=> reject(new Error("Network error during blob upload"));
      xhr.send(file);
    });
  }

  async function uploadToBlobWithSas(file, onProgress){
    const info = parseContainerInfo(containerSas);
    if (!info) throw new Error("Invalid container SAS URL.");
    const safeName = Date.now() + "_" + file.name.replace(/[^\w.\- ]+/g,'_');
    const putUrl = `${info.base}/${encodeURIComponent(safeName)}${info.query}`;
    await putWithProgress(
      putUrl,
      file,
      { "x-ms-blob-type": "BlockBlob", "x-ms-version": "2021-12-02", "Content-Type": file.type || "application/octet-stream" },
      onProgress
    );
    return `${info.base}/${encodeURIComponent(safeName)}`;
  }

  async function submitForm(e){
    e.preventDefault();
    const status = document.getElementById("status");
    status.textContent = "";

    if(!ME || ME.role!=="Creator"){
      status.textContent = "You must be Creator to upload.";
      return;
    }
    const body = {
      title:       document.getElementById("title").value.trim(),
      publisher:   document.getElementById("publisher").value.trim(),
      producer:    document.getElementById("producer").value.trim(),
      genre:       document.getElementById("genre").value.trim(),
      age:         document.getElementById("age").value.trim(),
      playbackUrl: document.getElementById("playbackUrl").value.trim(),
      external:    true
    };
    if(!body.title || !body.playbackUrl){
      status.textContent = "Title and Playback URL are required.";
      return;
    }

    try{
      document.getElementById("btnSubmit").disabled = true;
      status.textContent = "Saving…";
      const res = await fetch("/videos",{ method:"POST", headers: { ...authz({"Content-Type":"application/json"}) }, body: JSON.stringify(body) });
      const txt = await res.text();
      if(!res.ok){ status.textContent = `Save failed: ${res.status} ${res.statusText} — ${(txt||"").slice(0,180)}`; return; }
      status.textContent = "Saved ✓ (view it in All Videos)";
    }catch(e){ status.textContent = "Save error: "+e.message; }
    finally{ document.getElementById("btnSubmit").disabled = false; }
  }

  (async ()=>{
    renderAuthUI();
    if(ID_TOKEN) await refreshMe();
    gateUI();
    document.getElementById("btnSignIn").addEventListener("click", signIn);
    document.getElementById("btnSignOut").addEventListener("click", signOut);
    document.getElementById("btnRole").addEventListener("click", switchRole);
    document.getElementById("formWrap").addEventListener("submit", submitForm);
  })();
</script>
</body>
</html>
